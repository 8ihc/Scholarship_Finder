import os
import json
from google import genai
from google.genai import types
from pydantic import BaseModel, Field, ValidationError
from typing import List, Literal, Optional, Any

# --- 1. 配置與初始化 ---
MODEL_NAME = 'gemini-2.5-flash'

# 確保您的 API 金鑰已設定在環境變數 GOOGLE_API_KEY 中
try:
    client = genai.Client()
except Exception:
    print("錯誤：無法初始化 Gemini Client。請確認 GOOGLE_API_KEY 環境變數或憑證設定正確。")
    exit()


# --- 2. 最終版 17 個類別定義 (用於 Pydantic Literal 限制) ---
CATEGORIES = Literal[
    "學制相關", "年級相關", "學籍狀態", "領域/科系", "設籍地",
    "就讀地", "特殊身份", "父母狀態",
    "經濟相關證明", "核心學業要求", "操行/品德", "特殊能力/專長",
    "補助/獎學金排斥", "領獎學金後的義務", "金額與名額", "應繳文件",
    "其他（用於無法歸類的特殊要求）"
]
CONDITION_TYPES = Literal["限於", "包含", "屬性"]


# --- 3. Pydantic 巢狀結構定義 ---

class SubTag(BaseModel):
    """描述單一的條件、限制或屬性，用於巢狀結構。"""
    tag_category: CATEGORIES = Field(
        description="標籤大類別 (17 個類別之一)。"
    )
    condition_type: CONDITION_TYPES = Field(
        description="條件類型：限於（限制）、包含（OR集合）、屬性（描述）。"
    )
    tag_value: str = Field(
        description="從原文中準確提取並標準化具體條件，若資訊依賴於子條件(如金額隨學制變)，必須在內容中註明其依賴的條件。"
    )

class ScholarshipGroup(BaseModel):
    """代表獎學金內的一個獨立申請組別或階段 (如：清寒組、優良成績組)。"""
    group_name: str = Field(
        description="此組別或階段的名稱。如果獎學金只有一個組別，請命名為「通用組別」。"
    )
    requirements: List[SubTag] = Field(
        description="此組別下所有獨立的申請條件、限制、金額和文件要求清單。"
    )

class FinalTagsStructure(BaseModel):
    """最終輸出結構：包含所有組別和頂層共同條件。"""
    groups: List[ScholarshipGroup] = Field(
        default_factory=list,
        description="獎學金內所有獨立的申請組別清單。"
    )
    common_tags: List[SubTag] = Field(
        default_factory=list,
        description="適用於整個獎學金的通用條件（例如：不得兼領其他扶輪社獎學金、截止日期等）。"
    )

# 最終用於 API 呼叫的 Schema (JSON Schema 格式)
FINAL_SCHEMA_PYDANTIC = FinalTagsStructure.model_json_schema()


# --- 4. Prompt ---
SYSTEM_PROMPT = f"""
# 系統指令：專業獎學金標籤結構化引擎

你的任務是擔任專業的獎學金篩選標籤提取器。請仔細閱讀提供的獎學金全文，並將所有提取的資訊轉換為 **巢狀 Pydantic JSON 結構**。

**核心目標：**
1.  **分組：** 識別獎學金中的所有獨立申請組別。如果只有一個組別，請命名為「通用組別」。
2.  **分類：** 將每個組別下的條件，準確歸類到 17 個 `tag_category` 之一。
3.  **歸屬：** 將組別特有的條件放入該組的 `requirements` 列表內。
4.  **通用：** 將適用於整個獎學金的通用條件放入 `common_tags` 列表內。

## 標籤大類別 (tag_category)
你必須且只能使用以下 17 個分類作為 "tag_category" 的值：
{', '.join(CATEGORIES.__args__)}

---
## 🔖 標籤內容參考定義（輔助標準化，但非絕對限制）

請根據原文提取，若原文詞彙更具體，請提取原文。若原文內容與定義相符，則建議使用以下標準化描述：

* **學制相關：** 大學、碩士、博士、在職專班、進修部、推廣教育
* **年級相關：** 大一、大二、大三、大四、大四以上 (若有，註明上下學期)
* **學籍狀態：** 在學生、延畢生、轉學生、休學生等
* **領域/科系：** 必須提取原文中的 [領域] 或 [科系] 名稱
* **設籍地：** 必須提取原文中的 [祖籍]、[縣市]、[區/鄉] 或 [村/里]
* **就讀地：** 必須提取原文中的 [縣市] 或 [學校名稱]
* **特殊身份：** 原住民、僑生、陸生、身心障礙等
* **父母狀態：** [職業]、[單親] 等
* **經濟相關證明：** 低收入戶證明、中低收入戶證明、村里長提供之清寒證明、導師提供之清寒證明、家庭突遭變故、國稅局家戶所得證明等
* **核心學業要求：** 百分制或GPA、班級排名等
* **操行/品德：** 操行成績、獎懲紀錄、經他人推薦之品德相關證明等
* **特殊能力/專長：** 體育競賽、特殊專長、其他經驗
* **補助/獎學金排斥：** 不得兼領、可兼領、可兼領但有額度上限
* **領獎學金後的義務：** 須親自領獎、須配合服務/志工時數等

---
## 條件類型邏輯定義 (condition_type)
你只能使用 **「限於」**、**「包含」** 或 **「屬性」**。請根據以下功能性定義，判斷每一項標籤應屬於哪一種類型。

### 規則一：限於 (LimitedTo)
**功能性限制 (AND/強制要求)：** 凡是申請人必須滿足的單一或複合條件，都視為「限於」。

### 規則二：包含 (Includes)
**多重、可替代的合格集合 (OR/擇一滿足)：** 僅用於描述多種獨立、可替代的合格途徑，表示滿足集合中任一項即可通過該要求類別。

### 規則三：屬性 (Attribute)
**描述性特徵或義務 (Non-Eligibility)：** 適用於描述獎學金的量化資訊或申請人必須履行的義務等。

---
## 具體內容提取與格式要求 (tag_value)
提取具體內容時，必須遵守以下標準化要求：

1.  **核心學業要求：** 必須註明是學期/學年、百分制/GPA，以及具體的數字。
2.  **應繳文件：** 必須列出所有明確要求繳交的**實質性文件名稱**，排除流程性文件。
3.  **金額與名額：** 必須註明具體數字和單位。**如果該資訊依賴於其他子條件，必須在 `tag_value` 中明確註明其依賴的條件** (例如：「5 名，每人 6,000 元 (限大學生)」、「10 名，每人 10,000 元 (限碩士生)」)。
4.  **例外處理：** 無法歸類到 1-16 類的特殊要求，請使用 **第 17 類 (其他)**。

## JSON 輸出格式 (Schema)
你必須且只能輸出一個符合 `FinalTagsStructure` Pydantic 模型的 JSON 物件。
"""

# --- 5. 測試資料 (使用 ID 7897 的 full_text_for_llm 內容) ---
# 這是您提供的三重東區扶輪社資料，模型需要識別出清寒、成績、冠名三個組別
TEST_DATA_7897 = """
### 獎學金核心元數據 (FOR LLM REFERENCE) ###\n名稱: 114學年度『三重東區扶輪社獎助學金』\nID: 7897\n起始日期: 2025/12/3\n截止日期: 2026/2/5\n金額: 20000\n名額: 6名\n申請地點: 申請系統 本校學生財務支援服務系統 https://my.ntu.edu.tw/fao/login.aspx\n\n\n### 網站公告：申請資格 (Eligibility) - 原始文本 ###\n限設籍在三重、蘆洲、新莊、五股、泰山、八里、林口等7區在學大學生； 曾得過該社獎學金者請勿再申請 ， 若重複申請指定地區之其他扶輪社獎學金，即取消獲獎資格。 （一）清寒優良獎學金 ： 1、大學部大二以上在學學生。 2、父母雙亡、貧戶證明或家境清寒，且在民國112年7月1日前已設籍於指定區域者。 3 、 113學年操行80分以上、學業成績平均75分以上，且未受記過以上處分者。 ( 附獎懲紀錄證明 ) 4 、 113學年度內，經學校證明未領有其他獎學金及公費者 。 （二）成績優良獎學金 1 、 大學部在學學生。 2 、 民國112年7月1日前已設戶籍指定區域者。 3 、 113學年操行及學業成績平均80分以上，且未受記過以上處分者( 附獎懲紀錄證明 )。 4 、 113學年度內，經學校證明未領有其他獎學金者。 （三）冠名獎學金 ： 1 、 大學部在學學生。 2 、 民國112年7月1日前已設戶籍於三重區者。 3 、 113學年操行及學業成績平均80分以上，且未受記過以上處分者( 附獎懲紀錄證明 )。 4 、 113學年度內，經學校證明未領有其他獎學金者 。 ★注意：「113學年度內未領取其他獎助學金」，如有領取其他獎助學金又未告知設獎單位者，則依規定取消獲獎資格並列入本組紀錄。\n\n\n### 網站公告：應繳文件 (Required Documents) - 原始文本 ###\n★本獎學金請注意截止時間為2/5（四）下午5時止，逾期不予受理。 （一）待繳文件列表-登入系統填寫送出列印 （二）該會專用申請書（ 請填寫1份即可，並貼照片；推薦人請找所屬科系系主任，本組不予核蓋推薦單位與推薦人 ）。 （三）在學證明正本 （四） 歷年成績單正本、操行與獎懲證明、113學年度名次證明正本。 （五） 全家人 新式戶口名簿正本（需含記事） （勿附舊式戶口名簿影本）。 （六） 申請 「清寒獎學金」請務必附上政府低收或里長清寒證明，申請其他兩類不用附。 （七）113學年度未領其他獎學金之證明書，收件後統一由本組核章。 （八）「自傳及未來理想」，限用電腦打字（800字以內）。 （九）文章1篇─我對扶輪社的認知，限用電腦打字（2千字以上）。\n\n\n### 附件解析內容 ###\n\n--- 附件 1: 辦法及專用申請書 ---\nROTARY\nERNA\nTONAL\n三重東區扶輪社\nRotary Club Of Sanchung East\n獎助學金實施細則\n宗旨:\n鼓勵與資助本社轄區及鄰近地區(共計三重、蘆洲、新莊、五股、泰山、八里、林口共七區)在校成績優良及\n清寒優秀大學生而設。\n二、獎助學金之種類:\n(一)清寒優良獎學金 (二)成績優良獎學金 (三)冠名獎學金\n三、申請資格:\n(一)清寒優良獎學金\n1、現為公私立大專院校在校學生及五專五年級生(不包含研究所)。\n2、父母雙亡或貧戶證明或家境清寒,且在民國一一二年七月一日前已設籍於上述七區內。\n3、前學年(上、下學期)操行甲等、學業成績平均七十五分以上,且未受記過以上處分者。\n4、一一三學年度內,經學校證明未領有其他獎學金者。(領取行政院減免學雜費案者扔可申請)\n5、公費生不得申請。\n6、曾得過本社獎學金者請勿再申請。\n7、若重複申請上述七區內之其他扶輪社獎學金,即取消獲獎資格。\n(二)成績優良獎學金\n1、現為公私立大專院校在校學生(不包含研究所)。\n2、民國一一二年七月一日前已設戶籍於上述七區內者。\n3、前學年(上、下學期)操行甲等、學業成績平均八十分以上,且未受記過以上處分者。\n4、一一三學年度內,經學校證明未領有其他獎學金者。(領取行政院減免學雜費案者可申請)\n5、曾得過本社獎學金者請勿再申請。\n6、若重複申請上述七區之其他扶輪社獎學金,即取消獲獎資格。\n(三)冠名獎學金\n1、現為公私立大專院校在校學生(不包含研究所)。\n2、民國一一二年七月一日前已設戶籍於上述七區者。\n3、前學年(上、下學期)操行甲等、學業成績平均八十分以上,且未受記過以上處分者。\n4、一一三學年度內,經學校證明未領有其他獎學金者。(領取行政院減免學雜費案者扔可申請)\n5、曾得過本社獎學金者請勿再申請。\n6、若重複申請上述七區之其他扶輪社獎學金,即取消獲獎資格。\n四、名額及獎助金額:\n1、名額: 3 名。\n2、金額:每名新台幣貳萬元。\n五、申請日期:即日起迄至民國115年2月28日止。\n六、評審:經本社獎學金委員會初審,可能面談,再經理事會複審,於民國115年3/25前通知錄取\n者,未錄取者不另行通知,本社可依實際報名人數做適度的名額與相關辦法調整。\n七、獎助給付:於本社紀念慶典中頒發(可授權代領),時間、地點另行通知。\n八、申請手續:填具申請書二份,連同有關證明文件於規定日期前以掛號信寄交本社(以郵戳為憑)。\n備註:\n1、應繳附文件:\n(1)在學證明文件(研究所、進修推廣部除外)。\n(2)前學年(上、下學期)學業成績單及操行證明單乙份(需有體育成績)。\n(3)當月全戶戶籍謄本(請至戶政事務所申請,勿附戶口名簿)。\n(4)低收入戶或貧戶證明或里長之家境清寒證明乙份。\n(5)該年度未領其他獎學金之證明書。(領取行政院減免學雜費案者扔可申請)\n(6)自傳及未來理想,限用電腦打字(800字以內)\n(7)文章一篇--我對扶輪社的認知,限用電腦打字(2千字以上)。\n2、請填寫二份,於民國115年2月28日前一份寄交本社,一份由推薦單位存查。\n3、本申請書不夠時,請自行影印。或以e-mail:3490scerc@gmail.com 主旨:索取獎學金申請書電子檔\n郵寄地址:241 三重正義郵局第 00068 號郵政信箱 林主委世堂先生收 聯絡電話:(02)2988-8925 呂小姐\nRotary\nClub of Sanchung East"
"""

# --- 6. 執行測試 ---
def run_test():
    print(f"--- 呼叫 Gemini {MODEL_NAME} 進行巢狀標籤提取 (ID 7897) ---")

    try:
        # ！！！ 關鍵改動點 1：將 SYSTEM_PROMPT 移到 system_instruction 參數 ！！！
        response = client.models.generate_content(
            model=MODEL_NAME,
            
            # 關鍵改動點 2：contents 參數現在只包含數據，不包含長指令字串
            contents=[
                {"role": "user", "parts": [{"text": "請根據以下資料生成結構化標籤：\n\n### 待標籤的獎學金資料 ###\n" + TEST_DATA_7897}]}
            ],
            
            config=types.GenerateContentConfig(
                # 這裡使用了 SYSTEM_PROMPT 變數，模型會將其視為高優先級的系統設定
                system_instruction=SYSTEM_PROMPT, 
                response_mime_type="application/json",
                response_schema=FINAL_SCHEMA_PYDANTIC, 
            ),
        )
        
        # 核心優勢：使用 Pydantic 自動驗證模型輸出
        tags_object = FinalTagsStructure.model_validate_json(response.text)
        
        print("\n--- 標籤提取成功，Pydantic 驗證通過 ---")
        print("--- 解析後的巢狀標籤列表 ---")
        
        # 輸出美化後的 JSON
        print(json.dumps(tags_object.model_dump(), indent=4, ensure_ascii=False))
        
        # 額外提示：確認組別數量
        print(f"\n[摘要] 總共提取了 {len(tags_object.groups)} 個獨立組別。")
        if tags_object.common_tags:
             print(f"[摘要] 提取了 {len(tags_object.common_tags)} 個通用條件。")

    except ValidationError as e:
        print(f"\n🚨 Pydantic 驗證失敗：模型輸出的 JSON 結構不符合您的 Pydantic Schema。")
        print(f"錯誤詳情: {e}")
        # 在實際的批次處理中，您需要將 response.text 記錄下來進行人工檢查。
    except types.errors.APIError as e:
        print(f"\nAPI 錯誤：{e}")
        print("請檢查您的 API 金鑰是否有效，或確認 API 服務是否正常。")
    except Exception as e:
        print(f"\n發生錯誤: {e}")

if __name__ == "__main__":
    run_test()